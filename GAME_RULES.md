# AI9-PVE 游戏规则文档

## 1. 游戏目标
玩家控制一单位（Unit），在网格地图上穿梭于不同的市场之间，利用商品价格在不同时间、不同地点的波动进行低买高卖，以在有限时间内赚取尽可能多的资金。

## 2. 核心机制

### 2.1 地图与环境
- **世界结构**: 游戏发生在一个 $5 \times 5$ 的二维网格地图上。
- **地块类型**:
    - **空地 (Empty)**: 单位可以自由通行的区域。
    - **市场 (Market)**: 能够进行商品交易的场所。地图上随机生成 3 个市场。
- **时间系统**:
    - 游戏按离散的时间步（Tick）推进。
    - **1 Tick = 0.25 秒**。
    - 游戏总时长通常为 1000 步（在 Gym 环境中定义）。

### 2.2 经济系统
- **货币**: 玩家初始拥有 **1000** 资金。
- **商品**: 目前只有一种交易商品——**半导体 (Semiconductor)**。
- **价格波动**:
    - 每个市场的商品价格随时间独立波动，遵循正弦波规律。
    - 价格范围: **40 ~ 120**。
    - 价格公式: $P(t) = \text{Base} + (\text{Top} - \text{Base}) \times 0.5 \times (\sin(t) + 1)$。

## 3. 单位与行动

### 3.1 单位属性 (Unit)
- **数量**: 玩家仅控制 1 个单位。
- **背包容量**: **1** 个单位商品（即每次只能持有一件商品）。
- **状态 (State)**:
    - `idle`: 空闲/可行动。
    - `moving`: 移动中。
    - `loading`: 正在进货（购买中）。
    - `selling`: 正在出货（售卖中）。

### 3.2 动作指令 (Actions)
单位每回合可执行以下 7 种指令之一：

| 指令ID | 名称 | 描述 | 条件与消耗 |
| :--- | :--- | :--- | :--- |
| **0** | **Wait** | 原地待命 | 无消耗。 |
| **1-4** | **Move** | 移动 (上/下/左/右) | 瞬间完成位移 (逻辑上速度为 2格/秒)。 |
| **5** | **Buy** | 购买商品 | **条件**: <br>1. 位于市场附近 (距离 $\le 1$)<br>2. 资金充足<br>3. 背包未满<br>**消耗**: 需持续 1 Tick (0.25s) 完成交易。 |
| **6** | **Sell** | 出售商品 | **条件**: <br>1. 位于市场附近 (距离 $\le 1$)<br>2. 背包有货物<br>**效果**: 出售背包内**所有**货物。<br>**消耗**: 需持续 1 Tick (0.25s) 完成交易。 |

## 4. 交易流程详解

由于交易并非瞬间完成，系统采用了 **Busy Ticks** 机制：

1.  **发起交易**:
    - 当玩家下达 `Buy` 或 `Sell` 指令且满足条件时，单位进入 `loading` 或 `selling` 状态。
    - 单位被锁定，设置 `busy_ticks = 1`。
2.  **等待结算**:
    - 在接下来的 Tick 中，单位无法执行移动或其他指令，必须等待倒计时结束。
3.  **交易结算**:
    - 当 `busy_ticks` 归零时，系统执行扣款/入账和库存变更逻辑。
    - 交易完成后，单位状态恢复为 `idle`。

## 5. 评分与奖励 (RL Reward)
在强化学习环境中，奖励函数 (Reward Function) 设计如下：
- **资金奖励**: 每一步根据 `(当前资金 - 上一步资金)` 给予奖励。
    - 若资产增加（盈利），按比例给予正向奖励。
    - 若资产减少（亏损/投资），暂时累积，待盈利时结算。
- **时间惩罚**: 每一步扣除微量分数 (-0.005)，鼓励智能体尽快完成交易。

---
*注: 本规则基于当前代码 (`config/settings.py`, `main.py`) 逻辑生成，修改配置文件可能会改变部分参数。*
